generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

/**
 * =====================
 * ENUMS
 * =====================
 */

enum UserRole {
  CUSTOMER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum CreditLineStatus {
  ACTIVE
  SUSPENDED
  CLOSED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
}

enum OperationStatus {
  ACTIVE // activa
  PAID // pagado
  DEFAULTED // mora ya no se pago
}

enum InstallmentFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum InstallmentStatus {
  PENDING
  PAID
  LATE
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
}

/**
 * =====================
 * MODELS
 * =====================
 */

model User {
  id       String @id @default(uuid())
  name     String
  email    String @unique
  password String

  avatarUrl      String?  @db.Text
  documentNumber String?
  phone          String?
  role           UserRole @default(CUSTOMER)

  refreshToken String? @db.Text

  status UserStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  creditLine CreditLine?
}

model CreditLine {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  creditLimit  Decimal @db.Decimal(14, 4) // límite máximo de crédito
  interestRate Decimal @db.Decimal(5, 4) // tasa base si los productos no lo especifican

  status CreditLineStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  operations Operation[]
}

model Product {
  id String @id @default(uuid())

  name        String
  description String?
  imageUrl    String?
  brand       String
  price       Decimal @db.Decimal(14, 4) // precio de venta

  baseRate Decimal @db.Decimal(5, 4) // interés base del producto
  maxTerm  Int // máximo número de cuotas

  status ProductStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  operationProducts OperationProduct[]
}

model Operation {
  id String @id @default(uuid())

  creditLineId String
  creditLine   CreditLine @relation(fields: [creditLineId], references: [id])

  amount       Decimal              @db.Decimal(14, 4) // monto total de la operación (sumatoria de productos)
  interestRate Decimal              @db.Decimal(5, 4) // tasa promedio ponderada de la operación
  lateRate     Decimal              @db.Decimal(5, 4) // interés diario por mora
  term         Int // número de cuotas
  frequency    InstallmentFrequency

  status OperationStatus @default(ACTIVE)

  disbursedAt DateTime // fecha de entrega de dinero

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  installments      Installment[]
  operationProducts OperationProduct[]
}

model OperationProduct {
  operationId String
  operation   Operation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  amount       Decimal @db.Decimal(14, 4) // monto específico de este producto
  interestRate Decimal @db.Decimal(5, 4) // tasa de interés específica

  @@id([operationId, productId])
}

model Installment {
  id String @id @default(uuid())

  operationId String
  operation   Operation @relation(fields: [operationId], references: [id])

  number       Int // número de cuota en la operación
  dueDate      DateTime // fecha de vencimiento
  amount       Decimal  @db.Decimal(14, 4) // total de la cuota (suma de productos)
  principal    Decimal  @db.Decimal(14, 4) // amortización de capital
  interest     Decimal  @db.Decimal(14, 4) // interés
  lateInterest Decimal  @default(0) @db.Decimal(14, 4)

  status InstallmentStatus @default(PENDING)
  paidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments Payment[]

  @@unique([operationId, number])
}

model Payment {
  id String @id @default(uuid())

  installmentId String
  installment   Installment @relation(fields: [installmentId], references: [id])

  amount Decimal       @db.Decimal(14, 4) // monto del pago
  method PaymentMethod
  paidAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
